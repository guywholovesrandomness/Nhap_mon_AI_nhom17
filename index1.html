<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Map Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: 340px; background: #fff; border-right: 1px solid #ddd; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; z-index: 1000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        h2 { margin: 0; color: #0056b3; font-size: 18px; display: flex; align-items: center; gap: 5px;}
        
        .box { background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; margin-bottom: 5px; }
        .box.rain { background: #e3f2fd; border-color: #b3d7ff; }
        .box.traffic { background: #fff3cd; border-color: #ffeeba; }
        
        .lbl { font-size: 12px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .row { display: flex; gap: 5px; align-items: center; }
        
        input[type="text"] { flex: 1; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;}
        input[type="number"] { padding: 6px; width: 60px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;}
        
        button { padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; transition: 0.2s; }
        .btn-blue { background: #17a2b8; color: white; }
        .btn-green { background: #28a745; color: white; width: 100%; margin-top: 5px; font-size: 14px; } .btn-green:disabled { background: #ccc; }
        .btn-update { background: #007aff; color: white; flex: 1; }
        .btn-danger { background: #dc3545; color: white; width: 100%; margin-top: 5px; }
        .btn-reset { background: #6c757d; color: white; width: 100%; margin-top: 5px; }
        .btn-visual { background: #20c997; color: white; width: 100%; margin-top: 5px; }
        
        /* Mode Buttons Toggle */
        .mode-group { display: flex; gap: 2px; margin-top: 5px; }
        .mode-btn { flex: 1; border: 1px solid #ccc; background: #fff; color: #333; font-size: 11px; padding: 6px 2px;}
        .mode-btn.active-route { background: #28a745; color: white; border-color: #28a745; }
        .mode-btn.active-traffic { background: #ffc107; color: #000; border-color: #ffc107; }
        .mode-btn.active-forbidden { background: #343a40; color: white; border-color: #343a40; }
        
        .status { padding: 8px; background: #e9ecef; border-radius: 4px; font-size: 12px; text-align: center; font-weight: 500;}
        .chk-row { display: flex; align-items: center; gap: 5px; font-size: 12px; margin-top: 5px;}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ—ºï¸ Smart Map Pro</h2>

        <div class="box">
            <span class="lbl">ğŸ“ TÃ¬m Ä‘Æ°á»ng</span>
            <div style="margin-bottom: 5px;">
                <div style="margin-bottom: 10px;">
                    <span class="lbl">PhÆ°Æ¡ng tiá»‡n:</span>
                    <select id="vehicleType" style="width: 100%; padding: 5px;">
                        <option value="walk">ğŸš¶ Äi bá»™ (5 km/h)</option>
                        <option value="motorbike" selected>ğŸï¸ Xe mÃ¡y (25 km/h)</option>
                        <option value="car">ğŸš— Ã” tÃ´ (35 km/h)</option>
                    </select>
                </div>                
                <div class="row"><input id="startAddr" type="text" placeholder="Äiá»ƒm Ä‘i..."><button class="btn-blue" onclick="searchLoc('start')">ğŸ”</button></div>
                <div id="startCoord" style="font-size: 10px; color: #777;">ChÆ°a chá»n</div>
            </div>
            <div>
                <div class="row"><input id="endAddr" type="text" placeholder="Äiá»ƒm Ä‘áº¿n..."><button class="btn-blue" onclick="searchLoc('end')">ğŸ”</button></div>
                <div id="endCoord" style="font-size: 10px; color: #777;">ChÆ°a chá»n</div>
            </div>
            <button id="findBtn" class="btn-green" onclick="findPath()" disabled>ğŸš€ TÃ¬m Ä‘Æ°á»ng</button>
            <button class="btn-reset" onclick="resetAll()">ğŸ”„ Reset</button>
        </div>

        <div class="box rain">
            <span class="lbl" style="color:#0056b3">â˜” Ngáº­p lá»¥t & An toÃ n</span>
            <div class="row">
                <input id="rainInput" type="number" placeholder="mm" value="0">
                <span>mm</span>
                <button class="btn-update" onclick="setRain()">Cáº­p nháº­t</button>
            </div>
            <button class="btn-visual" onclick="showSafeRoads()">ğŸ‘ï¸ Xem Ä‘Æ°á»ng Ä‘i Ä‘Æ°á»£c</button>
        </div>

        <div class="box traffic">
            <span class="lbl" style="color:#856404">ğŸ› ï¸ CÃ´ng cá»¥ Báº£n Ä‘á»“</span>
            <div class="row">
                <span style="font-size: 12px;">Äá»™ táº¯c:</span>
                <select id="trafficLevel" style="flex:1; padding:6px; border:1px solid #ced4da; border-radius:4px; font-size:13px;">
                    <option value="light">ÄÃ´ng (x1.2)</option>
                    <option value="medium">Táº¯c vá»«a (x1.5)</option>
                    <option value="heavy">Táº¯c náº·ng (x2.0)</option>
                </select>
            </div>
            
            <div class="mode-group">
                <button id="btnRoute" class="mode-btn active-route" onclick="setMode('route')">ğŸ“ Chá»n</button>
                <button id="btnTraffic" class="mode-btn" onclick="setMode('traffic')">âš ï¸ Táº¯c</button>
                <button id="btnForbidden" class="mode-btn" onclick="setMode('forbidden')">â›” Cáº¥m</button>
            </div>

            <div style="display: flex; gap: 5px;">
                <button class="btn-danger" style="background: #ffc107; color: #000" onclick="clearData('traffic')">XÃ³a Táº¯c</button>
                <button class="btn-danger" style="background: #343a40;" onclick="clearData('forbidden')">XÃ³a Cáº¥m</button>
            </div>
        </div>

        <div class="chk-row">
            <input type="checkbox" id="showNodes"> <label for="showNodes">Hiá»‡n Nodes</label>
        </div>
        <div class="status" id="status">Sáºµn sÃ ng.</div>
    </div>
    
    <div id="map" style="flex-grow: 1;"></div>

    <script>
        const map = L.map('map').setView([20.9764, 105.8556], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM' }).addTo(map);

        let startMarker, endMarker, pathLayer;
        let trafficLayer = L.layerGroup().addTo(map);
        let forbiddenLayer = L.layerGroup().addTo(map); 
        let safeRoadsLayer = L.layerGroup().addTo(map);
        let nodesLayer = L.layerGroup();
        
        let startLL = null, endLL = null;
        let mode = 'route'; 
        let selectTarget = 'start';
        const statusEl = document.getElementById('status');
        const findBtn = document.getElementById('findBtn');
        const showNodesChk = document.getElementById('showNodes');

        // Icon cho cÃ¡c loáº¡i pin
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        const blackIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        // Biáº¿n chá»n Ä‘oáº¡n táº¯c Ä‘Æ°á»ng & Ä‘Æ°á»ng cáº¥m
        let trafficStartLL = null, trafficEndLL = null;
        let trafficStartMarker = null, trafficEndMarker = null;
        let forbiddenStartLL = null, forbiddenEndLL = null;
        let forbiddenStartMarker = null, forbiddenEndMarker = null;

        // --- MAP CLICK ---
        map.on('click', e => {
            if (mode === 'route') {
                if (pathLayer) resetAll();
                if (selectTarget === 'start') { 
                    setPt('start', e.latlng, "Click map"); 
                    selectTarget = 'end'; 
                } else { 
                    setPt('end', e.latlng, "Click map"); 
                    selectTarget = 'start'; 
                }
            } else if (mode === 'traffic') {
                handleTrafficClick(e.latlng);
            } else if (mode === 'forbidden') {
                handleForbiddenClick(e.latlng);
            }
        });

        // --- LOGIC CHÃNH ---
        function setPt(type, ll, label) {
            const elCoord = document.getElementById(type+'Coord');
            const elAddr = document.getElementById(type+'Addr');
            
            if (type === 'start') {
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker(ll).addTo(map).bindPopup("A").openPopup();
                startLL = ll;
            } else {
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker(ll, {icon: redIcon}).addTo(map).bindPopup("B").openPopup();
                endLL = ll;
            }
            elCoord.innerText = `${ll.lat.toFixed(5)}, ${ll.lng.toFixed(5)}`;
            if (label !== "Click map") elAddr.value = label;
            findBtn.disabled = !(startLL && endLL);
        }


async function findPath() {
    if (!startLL || !endLL) return;
    
    // [Má»šI] Láº¥y giÃ¡ trá»‹ phÆ°Æ¡ng tiá»‡n
    const vType = document.getElementById('vehicleType').value;
    const statusEl = document.getElementById('status'); // Äáº£m báº£o biáº¿n nÃ y tá»“n táº¡i
    
    statusEl.innerText = "Äang tÃ­nh toÃ¡n...";
    if (typeof pathLayer !== 'undefined' && pathLayer) map.removeLayer(pathLayer);

    try {
        const res = await fetch('http://localhost:5000/api/find-path', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                start: startLL,
                end: endLL,
                vehicle: vType // [Má»šI] Gá»­i loáº¡i xe
            })
        });
        
        const data = await res.json();
        if (data.status === 'success') {
            
            if (pathLayer) map.removeLayer(pathLayer); 

            // [Cáº¬P NHáº¬T] Xá»¬ LÃ RIÃŠNG CHO Ã” TÃ” (NÃ©t Ä‘á»©t cho Ä‘i bá»™, NÃ©t liá»n cho lÃ¡i xe)
            if (vType === 'car') {
                const color = 'blue';
                const dashStyle = {color: color, weight: 5, opacity: 0.7, dashArray: '10, 10'}; // NÃ©t Ä‘á»©t cho Ä‘i bá»™
                const solidStyle = {color: color, weight: 5, opacity: 0.9}; // NÃ©t liá»n cho lÃ¡i xe

                // pathLayer sáº½ lÃ  LayerGroup Ä‘á»ƒ chá»©a 3 Ä‘Æ°á»ng
                pathLayer = L.layerGroup(); 

                // 1. Váº½ Ä‘oáº¡n Ä‘i bá»™ Ä‘áº§u (nÃ©t Ä‘á»©t)
                if (data.path1_walk && data.path1_walk.length > 0) {
                    L.polyline(data.path1_walk, dashStyle).addTo(pathLayer);
                }

                // 2. Váº½ Ä‘oáº¡n lÃ¡i xe (nÃ©t liá»n)
                if (data.path2_drive && data.path2_drive.length > 0) {
                    L.polyline(data.path2_drive, solidStyle).addTo(pathLayer);
                }

                // 3. Váº½ Ä‘oáº¡n Ä‘i bá»™ cuá»‘i (nÃ©t Ä‘á»©t)
                if (data.path3_walk && data.path3_walk.length > 0) {
                    L.polyline(data.path3_walk, dashStyle).addTo(pathLayer);
                }

                pathLayer.addTo(map);
            } else {
                // Xá»­ lÃ½ cho xe mÃ¡y / Ä‘i bá»™ (ÄÃ£ thá»‘ng nháº¥t mÃ u)
                let color = 'lime'; // Sá»¬ Dá»¤NG MÃ€U XANH DÆ¯Æ NG CHO Táº¤T Cáº¢
                pathLayer = L.polyline(data.path, {color: color, weight: 5}).addTo(map);
            }
            
            // FIX: Äáº£m báº£o map.fitBounds() khÃ´ng bá»‹ lá»—i náº¿u pathLayer khÃ´ng há»£p lá»‡
            if (pathLayer) {
                try {
                    const bounds = pathLayer.getBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds);
                    }
                } catch (e) {
                    console.warn("Could not fit map bounds. Path might be too short or invalid.", e);
                }
            }
            
            // HIá»‚N THá»Š Káº¾T QUáº¢
            let msg = `âœ… Xong!\nâ±ï¸ Thá»i gian: ${data.time} phÃºt\nğŸ“ QuÃ£ng Ä‘Æ°á»ng: ${(data.distance/1000).toFixed(2)} km`;
            if(data.details && data.details.length > 0) {
                msg += `\n---\n${data.details.join('\n')}`;
            }
            statusEl.innerText = msg;
        } else {
            statusEl.innerText = "Lá»—i: " + data.message;
        }
    } catch(e) {
        console.error(e);
        statusEl.innerText = "Lá»—i káº¿t ná»‘i server.";
    }
}
async function showSafeRoads() {
    // 1. Tá»± Ä‘á»™ng láº¥y giÃ¡ trá»‹ tá»« Ã´ input vÃ  gá»­i lÃªn server trÆ°á»›c
    const rainVal = document.getElementById('rainInput').value;
    
    // Gá»­i cáº­p nháº­t mÆ°a (Ã¢m tháº§m)
    await fetch('http://localhost:5000/api/set-rain', {
        method: 'POST', 
        headers: {'Content-Type':'application/json'}, 
        body: JSON.stringify({rain: rainVal})
    });
    
    // 2. Sau Ä‘Ã³ má»›i láº¥y dá»¯ liá»‡u Ä‘Æ°á»ng ngáº­p
    if (showNodesChk.checked) {
        showNodesChk.checked = false;
        nodesLayer.clearLayers();
    }

    statusEl.textContent = `Äang táº£i dá»¯ liá»‡u vá»›i má»©c mÆ°a ${rainVal}mm...`;
    try {
        const res = await fetch('http://localhost:5000/api/safe-roads');
        const d = await res.json();

        safeRoadsLayer.clearLayers(); // XÃ³a sáº¡ch váº½ cÅ©

        const flooded = d.flooded_roads || [];
        
        // Náº¿u khÃ´ng cÃ³ Ä‘Æ°á»ng ngáº­p
        if (flooded.length === 0) {
            statusEl.textContent = "âœ… KhÃ´ng cÃ³ Ä‘Æ°á»ng nÃ o bá»‹ ngáº­p vá»›i lÆ°á»£ng mÆ°a nÃ y.";
            statusEl.style.color = "green";
            return;
        }

        // Váº½ Ä‘Æ°á»ng ngáº­p
        const allLatLngs = [];
        flooded.forEach(line => {
            L.polyline(line, {
                color: '#0066ff',   // MÃ u Ä‘á» tÆ°Æ¡i cáº£nh bÃ¡o
                weight: 4,          // DÃ y hÆ¡n chÃºt cho dá»… nhÃ¬n
                opacity: 0.8,
            }).addTo(safeRoadsLayer);
            allLatLngs.push(...line);
        });

        if (allLatLngs.length > 0) {
            map.fitBounds(allLatLngs, { padding: [40, 40] });
        }

        statusEl.textContent = `âš ï¸ CÃ³ ${flooded.length} Ä‘oáº¡n Ä‘Æ°á»ng bá»‹ NGáº¬P!`;
        statusEl.style.color = "red";

    } catch (e) {
        console.error(e);
        statusEl.textContent = "Lá»—i táº£i dá»¯ liá»‡u ngáº­p lá»¥t.";
    }
}

        // --- FORBIDDEN & TRAFFIC ---
        function setMode(m) {
            mode = m;
            document.getElementById('btnRoute').className = m==='route'?'mode-btn active-route':'mode-btn';
            document.getElementById('btnTraffic').className = m==='traffic'?'mode-btn active-traffic':'mode-btn';
            document.getElementById('btnForbidden').className = m==='forbidden'?'mode-btn active-forbidden':'mode-btn';
            
            if(m==='route') map.getContainer().style.cursor='crosshair';
            else if(m==='traffic') map.getContainer().style.cursor='copy'; 
            else map.getContainer().style.cursor='not-allowed'; // Icon cáº¥m
            
            const txt = {
                'route':'Chá»n Ä‘iá»ƒm Ä‘i/Ä‘áº¿n',
                'traffic':'Click 2 Ä‘iá»ƒm (Ä‘áº§u & cuá»‘i) cá»§a Ä‘oáº¡n Ä‘Æ°á»ng táº¯c',
                'forbidden':'Click 2 Ä‘iá»ƒm (Ä‘áº§u & cuá»‘i) cá»§a Ä‘oáº¡n Ä‘Æ°á»ng Cáº¤M'
            };
            statusEl.textContent = txt[m];
        }

        async function clearData(type) {
            const api = type==='traffic'?'/api/clear-traffic':'/api/clear-forbidden';
            const layer = type==='traffic'?trafficLayer:forbiddenLayer;
            if(confirm(`XÃ³a háº¿t dá»¯ liá»‡u ${type}?`)) {
                await fetch('http://localhost:5000'+api, {method:'POST'});
                layer.clearLayers();

                if (type === 'traffic') {
                    trafficStartLL = trafficEndLL = null;
                    trafficStartMarker = trafficEndMarker = null;
                } else {
                    forbiddenStartLL = forbiddenEndLL = null;
                    forbiddenStartMarker = forbiddenEndMarker = null;
                }

                statusEl.textContent = `ÄÃ£ xÃ³a ${type}.`;
            }
        }
        function resetAll() {
            // 1. XÃ³a cÃ¡c Ä‘iá»ƒm trÃªn báº£n Ä‘á»“
            if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
            
            // 2. XÃ³a Ä‘Æ°á»ng Ä‘i (kiá»ƒm tra ká»¹ Ä‘á»ƒ khÃ´ng lá»—i)
            if (pathLayer) { 
                map.removeLayer(pathLayer); 
                pathLayer = null; 
            }
            
            // 3. Reset cÃ¡c biáº¿n tá»a Ä‘á»™
            startLL = null; 
            endLL = null;
            
            // 4. XÃ³a chá»¯ trong cÃ¡c Ã´ nháº­p liá»‡u
            document.getElementById('startAddr').value = "";
            document.getElementById('endAddr').value = "";
            document.getElementById('startCoord').innerText = "ChÆ°a chá»n";
            document.getElementById('endCoord').innerText = "ChÆ°a chá»n";
            
            // 5. Reset Ã´ chá»n xe vá» máº·c Ä‘á»‹nh (Xe mÃ¡y)
            const vehicleSelect = document.getElementById('vehicleType');
            if(vehicleSelect) vehicleSelect.value = "motorbike"; 

            // 6. áº¨n báº£ng káº¿t quáº£ vÃ  reset tráº¡ng thÃ¡i
            const resultBox = document.getElementById('resultBox'); 
            if(resultBox) resultBox.style.display = 'none';
            
            document.getElementById('status').innerText = "Sáºµn sÃ ng.";
            
            // 7. Kiá»ƒm tra láº¡i nÃºt TÃ¬m Ä‘Æ°á»ng (Ä‘á»ƒ disable nÃ³)
            findBtn.disabled = true;
        }
        // --- Táº®C ÄÆ¯á»œNG THEO ÄOáº N ---
        function handleTrafficClick(ll) {
            if (!trafficStartLL) {
                trafficStartLL = ll;
                if (trafficStartMarker) trafficLayer.removeLayer(trafficStartMarker);
                trafficStartMarker = L.marker(ll, {icon: redIcon})
                    .addTo(trafficLayer)
                    .bindPopup("Äáº§u Ä‘oáº¡n táº¯c")
                    .openPopup();
                statusEl.textContent = "ÄÃ£ chá»n Ä‘iá»ƒm Ä‘áº§u. Chá»n tiáº¿p Ä‘iá»ƒm cuá»‘i cá»§a Ä‘oáº¡n táº¯c.";
            } else if (!trafficEndLL) {
                trafficEndLL = ll;
                if (trafficEndMarker) trafficLayer.removeLayer(trafficEndMarker);
                trafficEndMarker = L.marker(ll, {icon: redIcon})
                    .addTo(trafficLayer)
                    .bindPopup("Cuá»‘i Ä‘oáº¡n táº¯c")
                    .openPopup();
                addTrafficSegment();
            } else {
                // Náº¿u Ä‘Ã£ chá»n Ä‘á»§ 2 Ä‘iá»ƒm rá»“i mÃ  váº«n click tiáº¿p -> reset chá»n má»›i
                if (trafficStartMarker) trafficLayer.removeLayer(trafficStartMarker);
                if (trafficEndMarker) trafficLayer.removeLayer(trafficEndMarker);
                
                trafficStartLL = ll;
                trafficEndLL = null;
                trafficStartMarker = L.marker(ll, {icon: redIcon})
                    .addTo(trafficLayer)
                    .bindPopup("Äáº§u Ä‘oáº¡n táº¯c")
                    .openPopup();
                statusEl.textContent = "ÄÃ£ reset Ä‘oáº¡n táº¯c, hÃ£y chá»n Ä‘iá»ƒm cuá»‘i má»›i.";
            }
        }

        async function addTrafficSegment() {
            if (!trafficStartLL || !trafficEndLL) return;
            const level = document.getElementById('trafficLevel').value || 'light';
            statusEl.textContent = "Äang ghi nháº­n Ä‘oáº¡n Ä‘Æ°á»ng táº¯c...";

            try {
                const res = await fetch('http://localhost:5000/api/add-traffic', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        start: trafficStartLL,
                        end: trafficEndLL,
                        level
                    })
                });
                const d = await res.json();
                if (d.status === 'success') {
                    const color = d.color || (level === 'medium' ? '#ff7f00' : (level === 'heavy' ? '#ff0000' : '#ffd000'));
                    L.polyline(d.path, {color: color, weight: 5, opacity: 0.9}).addTo(trafficLayer);
                    statusEl.textContent = "ÄÃ£ thÃªm Ä‘oáº¡n Ä‘Æ°á»ng táº¯c.";
                } else {
                    alert(d.message || 'KhÃ´ng thÃªm Ä‘Æ°á»£c Ä‘oáº¡n táº¯c');
                    statusEl.textContent = "âŒ KhÃ´ng thÃªm Ä‘Æ°á»£c Ä‘oáº¡n táº¯c.";
                }
            } catch(e) {
                console.error(e);
                statusEl.textContent = "Lá»—i káº¿t ná»‘i server khi thÃªm Ä‘oáº¡n táº¯c.";
            } finally {
                // XÃ³a pin táº¡m thá»i sau khi xá»­ lÃ½ xong
                if (trafficStartMarker) trafficLayer.removeLayer(trafficStartMarker);
                if (trafficEndMarker) trafficLayer.removeLayer(trafficEndMarker);
                
                trafficStartLL = null;
                trafficEndLL = null;
                trafficStartMarker = null;
                trafficEndMarker = null;
            }
        }

        // --- ÄÆ¯á»œNG Cáº¤M THEO ÄOáº N ---
        function handleForbiddenClick(ll) {
            if (!forbiddenStartLL) {
                forbiddenStartLL = ll;
                if (forbiddenStartMarker) forbiddenLayer.removeLayer(forbiddenStartMarker);
                forbiddenStartMarker = L.marker(ll, {icon: blackIcon})
                    .addTo(forbiddenLayer)
                    .bindPopup("Äáº§u Ä‘oáº¡n Cáº¤M")
                    .openPopup();
                statusEl.textContent = "ÄÃ£ chá»n Ä‘iá»ƒm Ä‘áº§u Ä‘Æ°á»ng cáº¥m. Chá»n tiáº¿p Ä‘iá»ƒm cuá»‘i.";
            } else if (!forbiddenEndLL) {
                forbiddenEndLL = ll;
                if (forbiddenEndMarker) forbiddenLayer.removeLayer(forbiddenEndMarker);
                forbiddenEndMarker = L.marker(ll, {icon: blackIcon})
                    .addTo(forbiddenLayer)
                    .bindPopup("Cuá»‘i Ä‘oáº¡n Cáº¤M")
                    .openPopup();
                addForbiddenSegment();
            } else {
                // Náº¿u Ä‘Ã£ chá»n Ä‘á»§ 2 Ä‘iá»ƒm rá»“i mÃ  váº«n click tiáº¿p -> reset chá»n má»›i
                if (forbiddenStartMarker) forbiddenLayer.removeLayer(forbiddenStartMarker);
                if (forbiddenEndMarker) forbiddenLayer.removeLayer(forbiddenEndMarker);

                forbiddenStartLL = ll;
                forbiddenEndLL = null;
                forbiddenStartMarker = L.marker(ll, {icon: blackIcon})
                    .addTo(forbiddenLayer)
                    .bindPopup("Äáº§u Ä‘oáº¡n Cáº¤M")
                    .openPopup();
                statusEl.textContent = "ÄÃ£ reset Ä‘oáº¡n cáº¥m, hÃ£y chá»n Ä‘iá»ƒm cuá»‘i má»›i.";
            }
        }

        async function addForbiddenSegment() {
            if (!forbiddenStartLL || !forbiddenEndLL) return;
            statusEl.textContent = "Äang ghi nháº­n Ä‘oáº¡n Ä‘Æ°á»ng Cáº¤M...";
            try {
                const res = await fetch('http://localhost:5000/api/add-forbidden', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                        start: forbiddenStartLL,
                        end: forbiddenEndLL
                    })
                });
                const d = await res.json();
                if (d.status === 'success') {
                    L.polyline(d.path, {color: '#000000', weight: 5, opacity: 0.9}).addTo(forbiddenLayer);
                    statusEl.textContent = "ÄÃ£ Ä‘Ã¡nh dáº¥u Ä‘oáº¡n Ä‘Æ°á»ng Cáº¤M.";
                } else {
                    alert(d.message || 'KhÃ´ng thÃªm Ä‘Æ°á»£c Ä‘Æ°á»ng cáº¥m');
                    statusEl.textContent = "âŒ KhÃ´ng thÃªm Ä‘Æ°á»£c Ä‘Æ°á»ng cáº¥m.";
                }
            } catch(e) {
                console.error(e);
                statusEl.textContent = "Lá»—i káº¿t ná»‘i server khi thÃªm Ä‘Æ°á»ng cáº¥m.";
            } finally {
                // XÃ³a pin táº¡m thá»i sau khi xá»­ lÃ½ xong
                if (forbiddenStartMarker) forbiddenLayer.removeLayer(forbiddenStartMarker);
                if (forbiddenEndMarker) forbiddenLayer.removeLayer(forbiddenEndMarker);
                
                forbiddenStartLL = null;
                forbiddenEndLL = null;
                forbiddenStartMarker = null;
                forbiddenEndMarker = null;
            }
        }

        // --- CÃC HÃ€M KHÃC ---
        async function setRain() {
            const r = document.getElementById('rainInput').value;
            await fetch('http://localhost:5000/api/set-rain', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({rain:r})
            });
            statusEl.textContent = "ÄÃ£ cáº­p nháº­t mÆ°a.";
        }

        async function searchLoc(type) {
            const q = document.getElementById(type+'Addr').value;
            if(!q) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
            const d = await res.json();
            if(d.length) {
                const ll = {lat:parseFloat(d[0].lat), lng:parseFloat(d[0].lon)};
                if(pathLayer) resetAll();
                setPt(type, ll, d[0].display_name);
                map.setView(ll, 16);
            } else alert("KhÃ´ng tÃ¬m tháº¥y");
        }

        showNodesChk.addEventListener('change', async function() {
            if(this.checked) {
                safeRoadsLayer.clearLayers(); // Táº¯t SafeRoads náº¿u báº­t Node cho Ä‘á»¡ rá»‘i
                const res = await fetch('http://localhost:5000/api/all-nodes');
                const d = await res.json();
                d.nodes.forEach(n => L.circleMarker(n, {radius:2, color:'blue', opacity:0.3}).addTo(nodesLayer));
                nodesLayer.addTo(map);
            } else nodesLayer.clearLayers();
        });
        
        // Khá»Ÿi táº¡o cháº¿ Ä‘á»™ máº·c Ä‘á»‹nh
        setMode('route'); 
    </script>
</body>
</html>
